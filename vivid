#!/bin/bash

# ğŸ® VIVID - CLEAN LAUNCHER
# ========================
# Professional, minimal, works every time

set -e

GRAY='\033[0;37m'
BOLD='\033[1;37m'
NC='\033[0m'

print_msg() {
    echo -e "${GRAY}$1${NC}"
}

print_header() {
    echo -e "${BOLD}Vivid - Digital Vibrance Control${NC}"
    echo "================================="
    echo ""
}

# Auto-install dependencies silently
auto_setup() {
    print_msg "ğŸ”§ Setting up Vivid..."
    
    # Fix permissions
    chmod +x "$0" 2>/dev/null || true
    
    # Check dependencies
    local missing=()
    command -v g++ >/dev/null || missing+=("compiler")
    command -v meson >/dev/null || missing+=("meson")
    command -v ninja >/dev/null || missing+=("ninja")
    pkg-config --exists gtk4 || missing+=("gtk4")
    command -v xrandr >/dev/null || missing+=("xrandr")
    
    if [ ${#missing[@]} -gt 0 ]; then
        print_msg "ğŸ“¦ Installing: ${missing[*]}"
        
        if [ -f /etc/fedora-release ]; then
            sudo dnf install -y gcc-c++ meson ninja-build pkg-config gtk4-devel libX11-devel libXrandr-devel xrandr >/dev/null 2>&1
        elif [ -f /etc/debian_version ]; then
            sudo apt update >/dev/null 2>&1
            sudo apt install -y build-essential meson ninja-build pkg-config libgtk-4-dev libx11-dev libxrandr-dev x11-xserver-utils >/dev/null 2>&1
        elif [ -f /etc/arch-release ]; then
            sudo pacman -S --noconfirm base-devel meson ninja pkgconf gtk4 libx11 libxrandr xorg-xrandr >/dev/null 2>&1
        fi
    fi
}

# Clean build
build_vivid() {
    print_msg "ğŸ”¨ Building..."
    
    rm -rf builddir
    meson setup builddir --buildtype=release >/dev/null 2>&1
    meson compile -C builddir >/dev/null 2>&1
    
    if [ -f "builddir/vivid" ]; then
        print_msg "âœ… Ready"
    else
        print_msg "âŒ Build failed"
        exit 1
    fi
}

# Main logic
case "${1:-}" in
    "build")
        print_header
        auto_setup
        build_vivid
        ;;
    "clean")
        rm -rf builddir
        print_msg "âœ… Cleaned"
        ;;
    "install")
        if [ ! -f "builddir/vivid" ]; then
            print_msg "âŒ Build first: ./vivid build"
            exit 1
        fi
        sudo meson install -C builddir
        print_msg "âœ… Installed system-wide"
        ;;
    "")
        # Auto-setup and launch
        if [ ! -f "meson.build" ]; then
            print_msg "âŒ Run from VividLinux directory"
            exit 1
        fi
        
        print_header
        auto_setup
        
        if [ ! -f "builddir/vivid" ]; then
            build_vivid
        fi
        
        print_msg "ğŸš€ Launching Vivid..."
        exec ./builddir/vivid
        ;;
    *)
        if [ -f "builddir/vivid" ]; then
            exec ./builddir/vivid "$@"
        else
            print_msg "âŒ Build first: ./vivid build"
            exit 1
        fi
        ;;
esac
